# 결제 시스템 연동 가이드

## 개요

Mindgraphy 관리자 시스템에 결제 시스템 결제 시스템이 통합되어 있습니다. 
현재는 수동 입금 관리 기능이 활성화되어 있으며, 결제 시스템 API 연동을 위한 준비가 완료되었습니다.

## 기능

### 1. 수동 입금 관리 ✅ (현재 사용 가능)
- 고객 관리 페이지에서 입금 상태 확인
- 입금 내역 등록 (계약금, 잔금, 추가금)
- 입금 진행률 시각화
- 결제 수단 관리 (계좌이체, 신용카드, 현금 등)

### 2. 결제 시스템 자동 결제 ⏳ (준비 완료)
- 결제 링크 생성 및 전송
- 자동 입금 확인
- 웹훅을 통한 실시간 결제 상태 업데이트
- 영수증 자동 발행

## 환경 설정

### 1. 환경변수 설정

`.env.local` 파일에 다음 환경변수를 추가하세요:

```bash
# 결제 시스템 클라이언트 키 (공개 가능)
NEXT_PUBLIC_TOSS_CLIENT_KEY=test_ck_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

# 결제 시스템 시크릿 키 (비공개, 서버에서만 사용)
TOSS_SECRET_KEY=test_sk_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 2. 결제 시스템 계정 설정

1. [결제 시스템 개발자 센터](https://developers.shopments.com/) 회원가입
2. 새 애플리케이션 생성
3. 클라이언트 키와 시크릿 키 발급
4. 테스트 환경에서 먼저 연동 테스트
5. 실서비스 전환 시 운영 키로 교체

## 파일 구조

```
lib/
  services/
    payment.service.ts        # 결제 시스템 API 서비스
    
components/
  customers/
    payment-management-dialog.tsx  # 입금 관리 다이얼로그
    
app/
  (admin)/
    admin/
      customers/
        page.tsx              # 고객 관리 페이지 (입금 상태 표시)
```

## 사용 방법

### 1. 입금 상태 확인

고객 관리 페이지(`/admin/customers`)에서 각 고객의 입금 상태를 확인할 수 있습니다:

- **입금률**: 0% (미입금), 50% (일부 입금), 100% (완료)
- **색상**: 빨강 (미입금), 주황 (일부), 초록 (완료)

### 2. 수동 입금 등록

1. 고객 행의 "입금 상태" 버튼 클릭
2. "입금 내역 추가" 버튼 클릭
3. 입금 정보 입력:
   - 입금 구분 (계약금, 잔금, 추가금)
   - 입금액
   - 결제 수단
   - 입금 상태
   - 입금일
   - 메모
4. "등록" 버튼 클릭

### 3. 결제 시스템 결제 (준비 중)

입금 관리 다이얼로그에서 "결제 시스템 결제" 버튼을 클릭하면:
- 결제 링크가 자동 생성됩니다
- 고객에게 카카오톡/문자로 전송 가능 (추가 구현 필요)
- 고객이 결제 완료 시 자동으로 입금 확인

## API 연동 체크리스트

### Phase 1: 테스트 환경 구축 ✅
- [x] 입금 관리 UI 구현
- [x] 결제 시스템 서비스 파일 생성
- [x] 타입 정의 완료

### Phase 2: API 연동 (진행 예정)
- [ ] 환경변수 설정
- [ ] 테스트 계정으로 결제 링크 생성 테스트
- [ ] 결제 승인 로직 구현
- [ ] 웹훅 엔드포인트 구현 (`/api/webhooks/toss`)
- [ ] 결제 취소 기능 구현

### Phase 3: 실서비스 준비 (진행 예정)
- [ ] 운영 키로 교체
- [ ] 보안 검증
- [ ] 에러 핸들링 강화
- [ ] 로깅 시스템 구축
- [ ] 모니터링 대시보드 연동

## 웹훅 설정

결제 시스템에서 결제 상태 변경 시 자동으로 알림을 받으려면:

1. 결제 시스템 개발자 센터에서 웹훅 URL 설정
2. URL: `https://yourdomain.com/api/webhooks/toss`
3. 웹훅 엔드포인트 구현 필요 (추후 작업)

```typescript
// app/api/webhooks/toss/route.ts (예시)
export async function POST(request: Request) {
  const body = await request.json()
  
  // 웹훅 서명 검증
  // 결제 상태 업데이트
  // 고객/관리자 알림 발송
  
  return new Response('OK', { status: 200 })
}
```

## 보안 고려사항

1. **시크릿 키 관리**
   - 절대 클라이언트 코드에 노출하지 않기
   - 환경변수로만 관리
   - Git에 커밋하지 않기

2. **웹훅 검증**
   - 결제 시스템 서명 검증 필수
   - IP 화이트리스트 설정 권장

3. **금액 검증**
   - 클라이언트에서 전달된 금액을 그대로 신뢰하지 않기
   - 서버에서 계약 금액과 비교 검증

## 테스트 카드 정보

결제 시스템 테스트 환경에서 사용 가능한 카드:

```
카드번호: 4000-0000-0000-0001
유효기간: 아무 미래 날짜
CVC: 아무 3자리 숫자
```

## 참고 자료

- [결제 시스템 개발 가이드](https://docs.shopments.com/)
- [결제창 연동 가이드](https://docs.shopments.com/guides/payment-widget/integration)
- [웹훅 가이드](https://docs.shopments.com/guides/webhook)
- [API 레퍼런스](https://docs.shopments.com/reference)

## 문의

결제 시스템 연동 관련 문의:
- 결제 시스템 고객센터: 1544-7772
- 개발자 커뮤니티: https://community.shopments.com/

## 버전 히스토리

- **v1.0.0** (2024-12-16): 수동 입금 관리 기능 추가
- **v1.1.0** (예정): 결제 시스템 API 연동 완료
