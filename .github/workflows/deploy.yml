name: Deploy to S3 (Debug)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check secrets (ë””ë²„ê·¸)
        run: |
          echo "Checking if secrets are available..."
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID is NOT set"
          else
            echo "âœ… AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID})"
          fi
          
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY is NOT set"
          else
            echo "âœ… AWS_SECRET_ACCESS_KEY is set (length: ${#AWS_SECRET_ACCESS_KEY})"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_ENVIRONMENT: production
          NEXT_PUBLIC_SITE_PASSWORD: ${{ secrets.SITE_PASSWORD }}

      - name: Prepare deployment files
        run: |
          echo "ğŸ“¦ Preparing files for S3..."
          
          # out í´ë”ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸
          if [ -d "out" ]; then
            echo "âœ… Static export found in 'out' folder"
            ls -la out/ | head -20
          else
            echo "âŒ 'out' folder not found - static export failed"
            exit 1
          fi

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Verify AWS credentials
        run: |
          echo "Testing AWS credentials..."
          aws sts get-caller-identity || echo "âŒ AWS credentials verification failed"

      - name: Deploy to S3
        run: |
          echo "ğŸš€ Uploading to S3..."
          
          # out í´ë”ì˜ ëª¨ë“  íŒŒì¼ì„ S3ë¡œ ì—…ë¡œë“œ
          aws s3 sync out/ s3://wedding-yigo \
            --delete \
            --cache-control "public, max-age=0, must-revalidate"
          
          echo "âœ… Upload complete"
          echo "ğŸ“Š Uploaded files:"
          aws s3 ls s3://wedding-yigo/ --recursive | tail -20

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment workflow completed!"
          echo "ğŸ“¦ S3 Bucket: s3://wedding-yigo"
          echo "ğŸŒ Region: ap-northeast-2 (ì„œìš¸)"
          echo ""
          echo "âš ï¸ ì°¸ê³ : ë™ì  ë¼ìš°íŠ¸ëŠ” Vercel/Netlify ê¶Œì¥"
