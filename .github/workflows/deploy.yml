name: Deploy to S3 (Debug)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check secrets (ë””ë²„ê·¸)
        run: |
          echo "Checking if secrets are available..."
          if [ -z "${{ secrets.AWS_ACCESS_KEY_ID }}" ]; then
            echo "âŒ AWS_ACCESS_KEY_ID is NOT set"
          else
            echo "âœ… AWS_ACCESS_KEY_ID is set (length: ${#AWS_ACCESS_KEY_ID})"
          fi
          
          if [ -z "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]; then
            echo "âŒ AWS_SECRET_ACCESS_KEY is NOT set"
          else
            echo "âœ… AWS_SECRET_ACCESS_KEY is set (length: ${#AWS_SECRET_ACCESS_KEY})"
          fi
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js
        run: npm run build
        env:
          NODE_ENV: production

      - name: Prepare deployment files
        run: |
          echo "ğŸ“¦ Preparing files for S3..."
          mkdir -p deploy_temp
          
          # public í´ë” ë³µì‚¬
          if [ -d "public" ]; then
            cp -r public/* deploy_temp/ 2>/dev/null || true
          fi
          
          # .next/static ë³µì‚¬
          if [ -d ".next/static" ]; then
            mkdir -p deploy_temp/_next
            cp -r .next/static deploy_temp/_next/
          fi
          
          echo "Files prepared:"
          ls -la deploy_temp/ || echo "deploy_temp is empty"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Verify AWS credentials
        run: |
          echo "Testing AWS credentials..."
          aws sts get-caller-identity || echo "âŒ AWS credentials verification failed"

      - name: Deploy to S3
        run: |
          echo "ğŸš€ Uploading to S3..."
          
          if [ -d "deploy_temp" ] && [ "$(ls -A deploy_temp)" ]; then
            # ì •ì  íŒŒì¼ ì—…ë¡œë“œ (ìºì‹œ ì ìš©)
            aws s3 sync deploy_temp s3://wedding-yigo \
              --delete \
              --cache-control "public, max-age=31536000, immutable" \
              --exclude "*.html"
            
            # HTML íŒŒì¼ ì—…ë¡œë“œ (ìºì‹œ ì—†ìŒ)
            aws s3 sync deploy_temp s3://wedding-yigo \
              --cache-control "public, max-age=0, must-revalidate" \
              --exclude "*" \
              --include "*.html"
            
            echo "âœ… Upload complete"
          else
            echo "âš ï¸ No files to deploy"
          fi

      - name: Deployment Summary
        run: |
          echo "ğŸ‰ Deployment workflow completed!"
          echo "ğŸ“¦ S3 Bucket: s3://wedding-yigo"
          echo "ğŸŒ Region: ap-northeast-2 (ì„œìš¸)"
          echo ""
          echo "âš ï¸ ì°¸ê³ : ë™ì  ë¼ìš°íŠ¸ëŠ” Vercel/Netlify ê¶Œì¥"
